name: Add labels to PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  label:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed files and packages
        id: detect-changes
        run: |
          # Get all changed files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo ""

          # Automatically detect all packages
          PACKAGES=$(find packages -maxdepth 1 -type d -not -name "packages" -exec basename {} \; | sort)

          # Check special directories (apps)
          STORYBOOK_CHANGED=false
          DOCS_CHANGED=false

          if echo "$CHANGED_FILES" | grep -qE '^apps/storybook/|\.stories\.tsx$'; then
            STORYBOOK_CHANGED=true
          fi

          if echo "$CHANGED_FILES" | grep -q '^apps/docs/'; then
            DOCS_CHANGED=true
          fi

          # Build JSON array of changed packages
          CHANGED_PACKAGES='[]'

          for pkg in $PACKAGES; do
            if echo "$CHANGED_FILES" | grep -q "^packages/$pkg/"; then
              CHANGED_PACKAGES=$(echo "$CHANGED_PACKAGES" | jq --arg pkg "$pkg" '. += [$pkg]')
            fi
          done

          # Add special labels if changed
          if [ "$STORYBOOK_CHANGED" = true ]; then
            CHANGED_PACKAGES=$(echo "$CHANGED_PACKAGES" | jq '. += ["storybook"]')
          fi

          if [ "$DOCS_CHANGED" = true ]; then
            CHANGED_PACKAGES=$(echo "$CHANGED_PACKAGES" | jq '. += ["docs"]')
          fi

          echo "Detected packages: $(echo $PACKAGES | tr '\n' ', ')"
          echo "Changed packages/apps: $(echo $CHANGED_PACKAGES | jq -r '.[]' | tr '\n' ', ')"
          echo ""

          # Output as compact JSON for next step (remove whitespace/newlines)
          COMPACT_JSON=$(echo "$CHANGED_PACKAGES" | jq -c '.')
          echo "changed_packages=$COMPACT_JSON" >> $GITHUB_OUTPUT

      - name: Add labels dynamically
        uses: actions/github-script@v7
        with:
          script: |
            const changedPackages = JSON.parse('${{ steps.detect-changes.outputs.changed_packages }}');

            if (changedPackages.length === 0) {
              console.log('No package changes detected - skipping labels');
              return;
            }

            console.log('Changed packages/apps:', changedPackages);

            const labelsToAdd = changedPackages;
            const labelsForComment = changedPackages.map(label => '`' + label + '`');

            // Get existing labels in the repository
            const { data: existingLabels } = await github.rest.issues.listLabelsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            const existingLabelNames = existingLabels.map(l => l.name);

            // Create any labels that don't exist
            for (const label of labelsToAdd) {
              if (!existingLabelNames.includes(label)) {
                console.log(`Creating label: ${label}`);
                try {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label,
                    color: '6366f1', // Indigo color for package labels
                    description: `Changes to ${label}`
                  });
                } catch (error) {
                  // Label might have been created by another run
                  console.log(`Label ${label} may already exist: ${error.message}`);
                }
              }
            }

            // Add all applicable labels
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: labelsToAdd
            });

            // Handle PR comment
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComment = comments.data.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('üè∑Ô∏è Auto-labeled this PR:')
            );

            const newBody = `**üè∑Ô∏è Auto-labeled this PR:** ${labelsForComment.join(', ')}`;

            if (botComment) {
              if (botComment.body !== newBody) {
                await github.rest.issues.updateComment({
                  comment_id: botComment.id,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: newBody
                });
              }
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: newBody
              });
            }
