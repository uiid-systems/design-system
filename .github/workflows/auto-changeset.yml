name: Auto Changeset

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

jobs:
  auto-changeset:
    name: Auto Changeset Check
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Skip for release and bot PRs
        id: gate
        run: |
          if [[ "${{ github.head_ref }}" == changeset-release/* ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Release PR — skipping changeset check"
          elif [[ "${{ github.actor }}" == "dependabot[bot]" ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Dependabot PR — skipping changeset check"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.gate.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate changeset
        if: steps.gate.outputs.skip != 'true'
        run: |
          git fetch origin "${{ github.base_ref }}" --depth=1

          CHANGED_FILES=$(git diff --name-only "origin/${{ github.base_ref }}...HEAD")

          CHANGED_PACKAGE_COUNT=$(echo "$CHANGED_FILES" | awk -F/ '/^packages\/[^/]+\// { print $2 }' | sort -u | wc -l | tr -d ' ')
          NEW_CHANGESETS=$(echo "$CHANGED_FILES" | grep -cE '^\.changeset/.+\.md$' || true)

          if [ "${CHANGED_PACKAGE_COUNT:-0}" -eq 0 ]; then
            echo "No package changes detected — changeset not required."
            exit 0
          fi

          if [ "${NEW_CHANGESETS:-0}" -gt 0 ]; then
            echo "Found $NEW_CHANGESETS changeset(s) — OK."
            exit 0
          fi

          echo "::error::This PR changes packages but has no changeset."
          echo "::error::Run 'pnpm changeset' locally and commit the generated .changeset/*.md file."
          exit 1
