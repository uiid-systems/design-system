name: Release

on:
  push:
    branches:
      - main

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: "https://registry.npmjs.org"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Clean up stale release branch
        run: |
          git branch -D changeset-release/main 2>/dev/null || true
          OPEN_PR=$(gh pr list --state open --head changeset-release/main --json number --jq '.[0].number // empty')
          if [ -z "$OPEN_PR" ]; then
            git push origin --delete changeset-release/main 2>/dev/null || true
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release Pull Request or Publish
        id: changesets
        uses: changesets/action@v1.4.7
        with:
          version: pnpm run changeset:version
          publish: pnpm run build && pnpm run release
          commit: "chore(release): version packages and update changelogs"
          title: "chore(release): version packages"
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Clean up release PR description
        if: steps.changesets.outputs.pullRequestNumber
        run: |
          PR_NUMBER="${{ steps.changesets.outputs.pullRequestNumber }}"
          CURRENT_BODY=$(gh pr view $PR_NUMBER --json body --jq '.body')

          cat > /tmp/clean-pr-body.js << 'EOF'
          const fs = require('fs');
          const input = fs.readFileSync('/tmp/pr-body.txt', 'utf8');
          const lines = input.split('\n');
          const cleaned = [];
          let skipDependencyBlock = false;

          for (const line of lines) {
            if (line.match(/^Updated dependencies \[/)) {
              skipDependencyBlock = true;
              continue;
            }
            if (skipDependencyBlock && (line.match(/^\s+@uiid\//) || line.trim() === '')) {
              continue;
            }
            if (skipDependencyBlock && line.trim() !== '' && !line.match(/^\s+@uiid\//)) {
              skipDependencyBlock = false;
            }
            if (!skipDependencyBlock) {
              cleaned.push(line);
            }
          }

          console.log(cleaned.join('\n'));
          EOF

          echo "$CURRENT_BODY" > /tmp/pr-body.txt
          CLEANED_BODY=$(node /tmp/clean-pr-body.js)
          echo "$CLEANED_BODY" | gh pr edit $PR_NUMBER --body-file -
          rm -f /tmp/pr-body.txt /tmp/clean-pr-body.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate release notes
        if: steps.changesets.outputs.published == 'true'
        run: |
          VERSION=$(node -p "require('./packages/tokens/package.json').version")
          echo "RELEASE_VERSION=v${VERSION}" >> $GITHUB_ENV

          REPO="${{ github.repository }}"

          node -e "
            const fs = require('fs');
            const version = '${VERSION}';

            try {
              const changelog = JSON.parse(fs.readFileSync('packages/changelog.json', 'utf8'));
              const entry = changelog.find(e => e.version === version);

              if (!entry) {
                fs.writeFileSync('/tmp/release-notes.md', 'Release v' + version);
                process.exit(0);
              }

              const lines = [];
              const repo = '${REPO}';

              function linkPr(desc) {
                return desc.replace(/\(#(\d+)\)/, '([#\$1](https://github.com/' + repo + '/pull/\$1))');
              }

              const sections = [
                ['features', '## âœ¨ Features'],
                ['fixes', '## ðŸ› Bug Fixes'],
                ['refactors', '## â™»ï¸ Refactors'],
                ['performance', '## âš¡ Performance'],
                ['documentation', '## ðŸ“š Documentation'],
              ];

              for (const [key, heading] of sections) {
                if (entry.changes[key]?.length) {
                  lines.push(heading + '\\n');
                  entry.changes[key].forEach(f => lines.push('- ' + linkPr(f.description)));
                  lines.push('');
                }
              }

              fs.writeFileSync('/tmp/release-notes.md', lines.join('\\n'));
            } catch (error) {
              console.error('Failed to generate release notes:', error.message);
              fs.writeFileSync('/tmp/release-notes.md', 'Release v' + version);
            }
          "

      - name: Create GitHub Release
        if: steps.changesets.outputs.published == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_VERSION }}
          name: Release ${{ env.RELEASE_VERSION }}
          body_path: /tmp/release-notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
